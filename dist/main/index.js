var e=Object.create,t=Object.defineProperty,n=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,i=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,o=(e,i,o,s)=>{if(i&&typeof i==`object`||typeof i==`function`)for(var c=r(i),l=0,u=c.length,d;l<u;l++)d=c[l],!a.call(e,d)&&d!==o&&t(e,d,{get:(e=>i[e]).bind(null,d),enumerable:!(s=n(i,d))||s.enumerable});return e},s=(n,r,a)=>(a=n==null?{}:e(i(n)),o(r||!n||!n.__esModule?t(a,`default`,{value:n,enumerable:!0}):a,n));let c=require(`node:process`);c=s(c);let l=require(`node:events`);l=s(l);let u=require(`node:util`);u=s(u);let d=require(`electron`);d=s(d);let f=require(`node:path`);f=s(f);let p=require(`node:crypto`);p=s(p);let m=require(`node:fs`);m=s(m);let h=require(`node:fs/promises`);h=s(h);let g=function(e){return e.sendLog=`NodeIQQNTWrapperSession/getNTWrapperSession/getNodeMiscService/sendLog`,e.onQRCodeLoginSucceed=`NodeIKernelLoginService/get/addKernelLoginListener/onQRCodeLoginSucceed`,e.onRecvMsg=`NodeIQQNTWrapperSession/getNTWrapperSession/getMsgService/addKernelMsgListener/onRecvMsg`,e.sendMsg=`NodeIQQNTWrapperSession/getNTWrapperSession/getMsgService/sendMsg`,e.fetchUnitedCommendConfig=`NodeIQQNTWrapperSession/getNTWrapperSession/getUnitedConfigService/fetchUnitedCommendConfig`,e.onMsgRecall=`NodeIQQNTWrapperSession/getNTWrapperSession/getMsgService/addKernelMsgListener/onMsgRecall`,e}({});const _={minimumAmount:200,randomDelay:{min:2e3,max:4e3},redPackTextBlacklist:`挂&死&狗&测试`,groupBlacklist:``,senderBlacklist:``,skipPwd:!1,autoSendmsg:`谢谢`};var v=`星之杖`,y=`qwqnt-star-wand`,b=class{static async getConfig(e){let t=PluginSettings[e].readConfig(y,_);return this.mergeConfig(t,_)}static async updateConfig(e,t){PluginSettings[t].writeConfig(y,e),this.log(`Config已更新`,JSON.stringify(e,null,2))}static mergeConfig(e,t){let n=structuredClone(t);for(let[t,r]of Object.entries(e))if(Object.hasOwn(n,t)&&Object.prototype.toString.call(r)===Object.prototype.toString.call(n[t])){if(Array.isArray(r)){n[t]=[...new Set([...r,...n[t]])];continue}n[t]=r}return n}static log(...e){console.log(`${y}:`,...e)}static randomInteger(e,t){let n=e+Math.random()*(t+1-e);return Math.floor(n)}static wait(e){if(!(e<=0))return new Promise(t=>setTimeout(t,e))}},x=class{wrapperEmitter=new l.EventEmitter;#listenerMap=new Map;constructor(e,t,n={}){this.Wrapper=e,this.Session=t,this.config=n}logFn({argArray:e,applyRet:t,key:n}){if(!this.config.log||typeof this.config.log!=`boolean`&&!this.config.log.test(n))return;let r=this.config.logDepth,i={inspect(e){return(0,u.inspect)(e,{depth:r,colors:!0})},json(e){return JSON.stringify(e,null,2)}}[this.config.logType??`inspect`];if(console.log(`-----------------------------------------------`),console.log(`${n} 被调用`),e.length&&console.log(`参数: `,i(e)),t instanceof Promise)console.log(`返回值为 Promise，请观察后续打印内容`),t.then(e=>{console.log(`${n} 返回值: `),console.log(i(e))},e=>{console.log(`${n} 返回值: `),console.log(i(e))});else if(console.log(`返回值: `,i(t)),typeof t==`object`&&t){let e=Object.getOwnPropertyNames(t);e.length&&console.log(`返回值 keys: `,i(e)),console.log(`原型 keys: `,i(Object.getOwnPropertyNames(Object.getPrototypeOf(t))))}}hookInstance({instance:e,rootKey:t}){return new Proxy(e,{get:(n,r,i)=>{let a=Reflect.get(e,r,i);if(typeof a!=`function`)return a;let o=`${t}/${r}`;return(...t)=>{if(this.config.eventBlacklist?.some(e=>typeof e==`string`?o===e:e.test(o)))return;if(o.endsWith(`Listener`))if(r.startsWith(`add`)){let e=this.#listenerMap.get(o);t[0]=this.hookInstance({instance:t[0],rootKey:o}),e?e.add(t[0]):this.#listenerMap.set(o,new Set([t[0]]))}else{let e=this.#listenerMap.get(o.replace(`/remove`,`/add`));e&&e.delete(t[0])}t=(()=>{if(this.config.eventInterceptors?.[o])return Array.isArray(this.config.eventInterceptors[o])?this.config.eventInterceptors[o].reduce((e,n)=>n(e??t),t):this.config.eventInterceptors?.[o]?.(t)})()??t;let n=e[r](...t);if(n=(()=>{if(this.config.eventInterceptors?.[`${o}:response`])return Array.isArray(this.config.eventInterceptors[`${o}:response`])?this.config.eventInterceptors[`${o}:response`].reduce((e,r)=>r({applyRet:e??n,params:t}),n):this.config.eventInterceptors?.[`${o}:response`]?.({applyRet:n,params:t})})()??n,o.endsWith(`Service`)&&(n=this.hookInstance({instance:n,rootKey:o})),n instanceof Promise)n.then(e=>{let n={applyRet:e,params:t};this.wrapperEmitter.emit(o,n)},e=>{let n={applyRet:e,params:t};this.wrapperEmitter.emit(o,n)});else{let e={applyRet:n,params:t};this.wrapperEmitter.emit(o,e)}return this.logFn({argArray:t,applyRet:n,key:o}),n}}})}dispatchListener(e,t){let n=e.lastIndexOf(`/`),r=e.slice(0,n),i=e.slice(n+1),a=this.#listenerMap.get(r);if(!a)throw Error(`监听器尚未绑定，请确认参数是否正确`);return[...a].map(e=>{if(!e[i])throw Error(`未找到目标监听器`);return e[i](...t)})}};let S=!1;function C(e,t){return{log:e.log,logDepth:e.logDepth,logType:e.logType,eventBlacklist:Array.from(new Set([...e.eventBlacklist||[],...t.eventBlacklist||[]])),eventInterceptors:(()=>{let n={...e.eventInterceptors};for(let[e,r]of Object.entries(t.eventInterceptors||{}))n[e]?Array.isArray(n[e])?n[e].push(r):n[e]=[n[e],r]:n[e]=r;return n})()}}const w=(()=>(globalThis.starWand||(Object.defineProperty(globalThis,`starWand`,{value:new x,writable:!1,enumerable:!1}),S=!0,b.log(`StarWand 实例已初始化`)),globalThis.starWand))();function T(e={}){let{promise:t,resolve:n}=Promise.withResolvers();return w.config=S?e:C(w.config,e),S&&(c.default.dlopen=new Proxy(c.default.dlopen,{apply(e,t,n){let[,r]=n,i=Reflect.apply(e,t,n);if(r.includes(`wrapper.node`)){let e=n[0].exports,t=new Proxy(e,{get(t,n,r){let i=Reflect.get(e,n,r);return typeof i==`function`?new Proxy(function(){},{get(e,t,r){let a=Reflect.get(i,t,r);return typeof a==`function`?new Proxy(a,{apply(e,r,i){let a=`${n}/${t}`,o=Reflect.apply(e,r,i);if(w?.logFn({argArray:i,applyRet:o,key:a}),typeof o!=`object`)return o;let s=w.hookInstance({instance:o,rootKey:a});return a===`NodeIQQNTWrapperSession/getNTWrapperSession`&&(w.Session=s),s}}):a},construct(e,t,r){let a=Reflect.construct(i,t,r);return w?.logFn({key:n,applyRet:a,argArray:t}),w.hookInstance({instance:a,rootKey:n})}}):i}});w.Wrapper=n[0].exports=t}return i}})),w.wrapperEmitter.once(`NodeIQQNTWrapperSession/getNTWrapperSession/getMsgService`,()=>{n(w)}),t}let E;function D(e){d.Notification.isSupported()&&new d.Notification({title:v,body:e}).show()}function O(e){return e?.startsWith(`[QQ红包]`)&&!e.includes(`专属`)&&e.includes(`新版手机QQ`)}function k(e,t){let{senderBlacklist:n,groupBlacklist:r,redPackTextBlacklist:i}=e;return n.includes(t.senderUin)||r.includes(t.peerUid)||i.split(`&`).some(e=>t.elements[0]?.walletElement?.receiver.title.includes(e))}function A({chatType:e,peerUid:t,content:n}){return w.Session?.getMsgService().sendMsg(``,{chatType:e,peerUid:t,guildId:``},[{elementType:1,elementId:``,textElement:{content:n,atType:0,atUid:``,atTinyId:``,atNtUid:``,subElementType:0,atChannelId:``,linkInfo:null,atRoleId:``,atRoleColor:0,atRoleName:``,needNotify:0}}],new Map)}async function j(e,t){if(b.log(`收到一条红包新消息`,e),!E?.uid)throw Error(`暂未获取到自身数据，不参与本次抢红包`);if(k(t,e))throw Error(`当前红包在黑名单内，请手动领取`);let n=b.randomInteger(t.randomDelay.min,t.randomDelay.max);await b.wait(n),b.log(`本次延迟: ${n}ms`);let{chatType:r,msgSeq:i,peerUid:a,peerUin:o,senderUin:s}=e,c=s===E.uin,l=e.elements[0]?.walletElement?.msgType;if(l!==6||t.skipPwd){let{result:n,errMsg:s,grabRedBagRsp:l}=await w.Session.getMsgService().grabRedBag({recvUin:r===1?E.uin:o,peerUid:r===1?E.uid:a,recvType:r,name:`Nyaruhodo`,pcBody:e.elements[0].walletElement.pcBody,msgSeq:i,index:e.elements[0].walletElement.stringIndex,wishing:e.elements[0].walletElement.receiver.title});if(n!==0||l.result!==0)throw Error(s||`领取失败，红包可能已经抢空`);if(console.timeEnd(`抢红包总耗时`),+l.recvdOrder.amount<t.minimumAmount||c||r!==2||t.autoSendmsg.length===0)return;let u=t.autoSendmsg.split(`&`)[b.randomInteger(-1,t.autoSendmsg.length-1)];if(!u)return;setTimeout(()=>{A({chatType:r,peerUid:a,content:u})},b.randomInteger(3e3,5e3))}else if(l===6){let{result:t,errMsg:n}=await A({content:e.elements[0].walletElement.receiver.title,chatType:r,peerUid:a});if(t!==0)throw Error(n);console.timeEnd(`抢红包总耗时`)}else throw Error(`当前红包类型${l}并不被支持`)}async function M(e){E=globalThis.authData,w.wrapperEmitter.removeAllListeners(g.onRecvMsg),d.ipcMain.removeAllListeners(`${y}:update`);let t=e??await b.getConfig(`main`);w.wrapperEmitter.addListener(g.onRecvMsg,async({params:e})=>{let n=e[0];try{for(let e of n){let{peerName:n}=e,r=n||`你的好友`;for(let n of e.elements){if(n.textElement&&O(n.textElement.content))throw Error(`${r}发送了红包，请使用手机领取`);n.walletElement&&n.walletElement.msgType!==8&&(await j(e,t),D(`已自动领取${r}发送的红包`))}}}catch(e){b.log(e),e instanceof Error&&D(e.message)}}),d.ipcMain.on(`${y}:update`,(e,t)=>{M(t)})}const N=new Map,P=5e3;function F(e){for(let t of e.elements){if(t.elementType!==10||!t.arkElement)continue;let n=JSON.parse(t.arkElement.bytesData);n.meta?.detail_1?.qqdocurl&&(t.textElement={content:n.meta?.detail_1?.qqdocurl,atType:0,atUid:`0`,atTinyId:`0`,atNtUid:``,subElementType:1,atChannelId:`0`,linkInfo:{title:n.meta.detail_1.title||``,icon:n.meta.detail_1.icon||``,desc:n.meta.detail_1.desc||``,richStatus:2,tencentDocType:null},atRoleId:`0`,atRoleColor:0,atRoleName:``,needNotify:0},t.elementType=1,t.arkElement=null,e.msgType=2)}}const I={"NodeIQQNTWrapperSession/getNTWrapperSession/getMsgService/addKernelMsgListener/onRecvMsg":function([e]){let t=e[0];t&&(F(t),N.size>=5e3&&N.clear(),N.set(t.msgId,t))},"NodeIQQNTWrapperSession/getNTWrapperSession/getMsgService/addKernelMsgListener/onMsgInfoListUpdate":function([e]){let t=e[0];if(t){if(t.elements.length===1&&t.elements[0]?.grayTipElement?.revokeElement&&!t.elements[0]?.grayTipElement?.revokeElement.isSelfOperate)throw Error(`阻止替换撤回消息`);F(t)}},"NodeIQQNTWrapperSession/getNTWrapperSession/getMsgService/getMsgsIncludeSelf:response":async function({applyRet:e}){let t=await e;for(let[e,n]of t.msgList.entries())if(F(n),n.elements[0]?.grayTipElement?.revokeElement){let r=N.get(n.msgId);r&&(t.msgList[e]=r)}return t},"NodeIQQNTWrapperSession/getNTWrapperSession/getMsgService/getAioFirstViewLatestMsgs:response":async function({applyRet:e}){let t=await e;for(let[e,n]of t.msgList.entries())if(F(n),n.elements[0]?.grayTipElement?.revokeElement){let r=N.get(n.msgId);r&&(t.msgList[e]=r)}return t}},L={"NodeIQQNTWrapperSession/getNTWrapperSession/getMsgService/checkMsgWithUrl:response":async function({applyRet:e}){let t=await e;for(let e of t.checkUrlsResult)e.jumpUrl=e.url,e.jumpResult=11;return t}};let R=function(e){return e[e.TextElement=1]=`TextElement`,e[e.PicElement=2]=`PicElement`,e[e.FileElement=3]=`FileElement`,e[e.PttElement=4]=`PttElement`,e[e.VideoElement=5]=`VideoElement`,e[e.FaceElement=6]=`FaceElement`,e[e.ReplyElement=7]=`ReplyElement`,e[e.GrayTipElement=8]=`GrayTipElement`,e[e.ArkElement=10]=`ArkElement`,e[e.AvRecordElement=21]=`AvRecordElement`,e}({});var z=class{static isVideoFile(e){let t=[`.mp4`,`.avi`,`.mkv`,`.mov`,`.wmv`,`.flv`,`.webm`,`.m4v`,`.mpeg`,`.mpg`,`.3gp`],n=(0,f.extname)(e).toLowerCase();return t.includes(n)}static isImgFile(e){let t=[`.jpg`,`.jpeg`,`.png`,`.gif`,`.bmp`,`.webp`,`.avif`,`.svg`],n=(0,f.extname)(e).toLowerCase();return t.includes(n)}static getFileMD5(e){let t=(0,p.createHash)(`md5`),n=(0,m.readFileSync)(e);return t.update(n),t.digest(`hex`)}static checkFileExists(e,t=200,n=10){let{promise:r,resolve:i,reject:a}=Promise.withResolvers(),o=0,s=async()=>{o++;try{await(0,h.access)(e),i(e)}catch{if(o>n)return a(Error(`找不到视频封面`));setTimeout(s,t)}};return s(),r}static async copyFileWithDirCheck(e,t){let n=f.default.dirname(t);try{await(0,h.access)(n,h.constants.F_OK)}catch{await(0,h.mkdir)(n,{recursive:!0})}await(0,h.copyFile)(e,t)}};function B(e,t,n){let r=z.getFileMD5(e),i=w?.Session?.getMsgService().getRichMediaFilePathForGuild({md5HexStr:r,fileName:t,elementType:n,elementSubType:0,thumbSize:0,needCreate:!0,downloadType:1,file_uuid:``});if(!i)throw Error(`无法获取视频上传路径`);return{uploadPath:i,md5HexStr:r}}function V(e){let t=e.replace(`Ori`,`Thumb`);return(0,f.join)((0,f.dirname)(t),`${(0,f.basename)(t,(0,f.extname)(t))}_0.png`)}async function H(e){let{fileName:t,filePath:n,picHeight:r,picWidth:i,picThumbPath:a,fileSize:o}=e[2][0]?.fileElement,{md5HexStr:s,uploadPath:c}=B(n,t,R.VideoElement),l=a?.get(750);if(!l)throw Error(`视频封面丢失`);await Promise.all([z.copyFileWithDirCheck(n,c),z.checkFileExists(l)]);let u=V(c);await z.copyFileWithDirCheck(l,u);let d=new Map;d.set(0,u);let f={elementType:R.VideoElement,elementId:``,videoElement:{filePath:c,fileName:t,videoMd5:s,thumbMd5:z.getFileMD5(l),fileSize:o,thumbWidth:i,thumbHeight:r,thumbPath:d}};return e[2][0]=f,w?.Session?.getMsgService().sendMsg(...e)}async function U(e){let{fileName:t,filePath:n,picHeight:r,picWidth:i,fileSize:a}=e[2][0]?.fileElement,{md5HexStr:o,uploadPath:s}=B(n,t,R.PicElement);await z.copyFileWithDirCheck(n,s);let c={elementType:R.PicElement,elementId:``,picElement:{md5HexStr:o,fileSize:a,picWidth:i??0,picHeight:r??0,fileName:`${o}.${(0,f.extname)(n).toLowerCase()}`,sourcePath:``,original:!0,picType:1e3,picSubType:0,fileUuid:``,fileSubId:``,thumbFileSize:0,summary:``}};return e[2][0]=c,w?.Session?.getMsgService().sendMsg(...e)}const W={"NodeIQQNTWrapperSession/getNTWrapperSession/getMsgService/sendMsg":function(e){if(e[1].chatType===8||e[2][0]?.elementType!==R.FileElement)return e;let{filePath:t,fileSize:n}=e[2][0].fileElement;if(n/1024/1024>=99)return e;if(z.isVideoFile(t))throw H(e),Error(`喵喵喵`);if(z.isImgFile(t))throw U(e),Error(`喵喵喵`);return e}};(async()=>{await T({log:!1,logDepth:null,eventBlacklist:[g.sendLog,/tianshu/i],eventInterceptors:{...L,...W,...I}}),M()})();