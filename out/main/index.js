"use strict";const te=require("node:events"),re=require("crypto"),O=require("node:https"),K=require("node:http"),F=require("node:fs"),B=require("node:process"),I=require("node:util"),S=require("node:path"),ne=require("node:crypto"),N=require("node:fs/promises");class se{ListenerMap;WrapperSession;ListenerManger=new Map;EventTask=new Map;constructor(){}createProxyDispatch(e){const t=this;return new Proxy({},{get(r,s,i){return typeof r[s]>"u"?(...o)=>{t.DispatcherListener.apply(t,[e,s,...o]).then()}:Reflect.get(r,s,i)}})}init({ListenerMap:e,WrapperSession:t}){this.ListenerMap=e,this.WrapperSession=t}CreatEventFunction(e){const t=e.split("/");if(t.length>1){const r="get"+t[0].replace("NodeIKernel",""),s=t[1],i=this.WrapperSession[r]();let o=i[s];return o=o.bind(i),o||void 0}}CreatListenerFunction(e,t=""){const r=this.ListenerMap[e];let s=this.ListenerManger.get(e+t);if(!s&&r){s=new r(this.createProxyDispatch(e));const i=e.match(/^NodeIKernel(.*?)Listener$/)[1],o="NodeIKernel"+i+"Service/addKernel"+i+"Listener";this.CreatEventFunction(o)(s),this.ListenerManger.set(e+t,s)}return s}async DispatcherListener(e,t,...r){this.EventTask.get(e)?.get(t)?.forEach((s,i)=>{if(s.createtime+s.timeout<Date.now()){this.EventTask.get(e)?.get(t)?.delete(i);return}s.checker&&s.checker(...r)&&s.func(...r)})}async CallNoListenerEvent(e="",t=3e3,...r){return new Promise(async(s,i)=>{const o=this.CreatEventFunction(e);let c=!1;setTimeout(()=>{c||i(new Error("NTEvent EventName:"+e+" timeout"))},t);const l=await o(...r);c=!0,s(l)})}async CallNormalEvent(e="",t="",r=1,s=3e3,i,...o){return new Promise(async(c,l)=>{const a=re.randomUUID();let p=0,u,h={};const g=()=>{p==0?l(new Error("NTEvent EventName:"+e+" ListenerName:"+t+" timeout")):c([h,...u])},C=setTimeout(g,s),d=t.split("/"),y=d[0],v=d[1],R={timeout:s,createtime:Date.now(),checker:i,func:(...M)=>{p++,u=M,p>=r&&(clearTimeout(C),g())}};this.EventTask.get(y)||this.EventTask.set(y,new Map),this.EventTask.get(y)?.get(v)||this.EventTask.get(y)?.set(v,new Map),this.EventTask.get(y)?.get(v)?.set(a,R),this.CreatListenerFunction(y),h=await this.CreatEventFunction(e)(...o)})}}class ie{core;constructor(e){this.core=e}async copyFile(e,t){await this.core.util.copyFile(e,t)}async getFileSize(e){return await this.core.util.getFileSize(e)}async getVideoUrl(e,t){return(await this.core.session.getRichMediaService().getVideoPlayUrlV2({chatType:e.chatType,peerUid:e.peerUid,guildId:"0"},e.msgId,t.elementId,0,{downSourceType:1,triggerType:1})).urlResult.domainUrl[0].url}}class oe{core;constructor(e){this.core=e}async setCacheSilentScan(e=!0){return""}getCacheSessionPathList(){return""}clearCache(e=["tmp","hotUpdate"]){return this.core.session.getStorageCleanService().clearCacheDataByKeys(e)}addCacheScannedPaths(e={}){return this.core.session.getStorageCleanService().addCacheScanedPaths(e)}scanCache(){return this.core.session.getStorageCleanService().scanCache()}getHotUpdateCachePath(){return""}getDesktopTmpPath(){return""}getChatCacheList(e,t=1e3,r=0){return this.core.session.getStorageCleanService().getChatCacheInfo(e,t,1,r)}getFileCacheInfo(e,t=1e3,r){}async clearChatCache(e=[],t=[]){return this.core.session.getStorageCleanService().clearChatCacheInfo(e,t)}}class ce{core;constructor(e){this.core=e}async isBuddy(e){return this.core.session.getBuddyService().isBuddy(e)}async getFriends(e=!1){let[t,r]=await this.core.event.CallNormalEvent("NodeIKernelBuddyService/getBuddyList","NodeIKernelBuddyListener/onBuddyListChange",1,5e3,()=>!0,e);const s=[];for(const i of r)for(const o of i.buddyList)s.push(o);return s}async handleFriendRequest(e,t){let r=e.split("|");if(r.length<2)return;let s=r[0],i=r[1];this.core.session.getBuddyService()?.approvalFriendRequest({friendUid:s,reqTime:i,accept:t})}}var k=(n=>(n[n.TEXT=1]="TEXT",n[n.PIC=2]="PIC",n[n.FILE=3]="FILE",n[n.PTT=4]="PTT",n[n.VIDEO=5]="VIDEO",n[n.FACE=6]="FACE",n[n.REPLY=7]="REPLY",n[n.ARK=10]="ARK",n[n.MFACE=11]="MFACE",n[n.MARKDOWN=14]="MARKDOWN",n))(k||{}),V=(n=>(n[n.DEFAULTTYPE=0]="DEFAULTTYPE",n[n.TITLETYPE=1]="TITLETYPE",n[n.NEWGROUPTYPE=2]="NEWGROUPTYPE",n))(V||{});class ae{core;constructor(e){this.core=e}async getGroups(e=!1){let[t,r,s]=await this.core.event.CallNormalEvent("NodeIKernelGroupService/getGroupList","NodeIKernelGroupListener/onGroupListUpdate",1,5e3,()=>!0,e);return s}async getGroupRecommendContactArkJson(e){return this.core.session.getGroupService().getGroupRecommendContactArkJson(e)}async CreatGroupFileFolder(e,t){return this.core.session.getRichMediaService().createGroupFolder(e,t)}async DelGroupFile(e,t){return this.core.session.getRichMediaService().deleteGroupFile(e,[102],t)}async DelGroupFileFolder(e,t){return this.core.session.getRichMediaService().deleteGroupFolder(e,t)}async getSingleScreenNotifies(e){let[t,r,s,i]=await this.core.event.CallNormalEvent("NodeIKernelGroupService/getSingleScreenNotifies","NodeIKernelGroupListener/onGroupSingleScreenNotifies",1,5e3,()=>!0,!1,"",e);return i}async getGroupMembers(e,t=3e3){const r=this.core.session.getGroupService(),s=r.createMemberListScene(e,"groupMemberList_MainWindow"),i=await r.getNextMemberList(s,void 0,t);if(i.errCode!==0)throw"获取群成员列表出错,"+i.errMsg;return i.result.infos}async getGroupNotifies(){}async GetGroupFileCount(e){return this.core.session.getRichMediaService().batchGetGroupFileCount(e)}async getGroupIgnoreNotifies(){}async getArkJsonGroupShare(e){return(await this.core.event.CallNoListenerEvent("NodeIKernelGroupService/getGroupRecommendContactArkJson",5e3,e)).arkJson}async handleGroupRequest(e,t,r){return this.core.session.getGroupService().operateSysNotify(!1,{operateType:t,targetMsg:{seq:e.seq,type:e.type,groupCode:e.group.groupCode,postscript:r||""}})}async quitGroup(e){return this.core.session.getGroupService().quitGroup(e)}async kickMember(e,t,r=!1,s=""){return this.core.session.getGroupService().kickMember(e,t,r,s)}async banMember(e,t){return this.core.session.getGroupService().setMemberShutUp(e,t)}async banGroup(e,t){return this.core.session.getGroupService().setGroupShutUp(e,t)}async setMemberCard(e,t,r){return this.core.session.getGroupService().modifyMemberCardName(e,t,r)}async setMemberRole(e,t,r){return this.core.session.getGroupService().modifyMemberRole(e,t,r)}async setGroupName(e,t){return this.core.session.getGroupService().modifyGroupName(e,t,!1)}async setGroupTitle(e,t,r){}async getGroupRemainAtTimes(e){this.core.session.getGroupService().getGroupRemainAtTimes(e)}async getMemberExtInfo(e,t){return this.core.session.getGroupService().getMemberExtInfo({groupCode:e,sourceType:V.TITLETYPE,beginUin:"0",dataTime:"0",uinList:[t],uinNum:"",seq:"",groupType:"",richCardNameVer:"",memberExtFilter:{memberLevelInfoUin:1,memberLevelInfoPoint:1,memberLevelInfoActiveDay:1,memberLevelInfoLevel:1,memberLevelInfoName:1,levelName:1,dataTime:1,userShowFlag:1,sysShowFlag:1,timeToUpdate:1,nickName:1,specialTitle:1,levelNameNew:1,userShowFlagNew:1,msgNeedField:1,cmdUinFlagExt3Grocery:1,memberIcon:1,memberInfoSeq:1}})}}class le{core;constructor(e){this.core=e}async setEmojiLike(e,t,r,s=!0){return r=r.toString(),this.core.session.getMsgService().setMsgEmojiLikes(e,t,r,r.length>3?"2":"1",s)}async getMultiMsg(e,t,r){return this.core.session.getMsgService().getMultiMsg(e,t,r)}async getMsgsByMsgId(e,t){return await this.core.session.getMsgService().getMsgsByMsgId(e,t)}async getMsgsBySeqAndCount(e,t,r,s,i){return await this.core.session.getMsgService().getMsgsBySeqAndCount(e,t,r,s,i)}async activateChat(e){}async activateChatAndGetHistory(e){}async sendMsgExtend(e,t){let r=this.core.session.getMsgService().getMsgUniqueId(Date.now().toString());return this.core.session.getMsgService().sendMsg(r,e,t,new Map)}async setMsgRead(e){return this.core.session.getMsgService().setMsgRead(e)}async getMsgHistory(e,t,r){return this.core.session.getMsgService().getMsgsIncludeSelf(e,t,r,!0)}async fetchRecentContact(){}async recallMsg(e,t){await this.core.session.getMsgService().recallMsg({chatType:e.chatType,peerUid:e.peerUid},t)}async forwardMsg(e,t,r){return this.core.session.getMsgService().forwardMsg(r,e,[t],new Map)}}class m{static async HttpsGetCookies(e){const t=e.startsWith("https")?O:K;return new Promise((r,s)=>{t.get(e,o=>{let c={};const l=a=>{if(a.statusCode===301||a.statusCode===302)if(a.headers.location){const p=new URL(a.headers.location,e);m.HttpsGetCookies(p.href).then(u=>{c={...c,...u},r(c)}).catch(u=>{s(u)})}else r(c);else r(c)};o.on("data",()=>{}),o.on("end",()=>{l(o)}),o.headers["set-cookie"]&&o.headers["set-cookie"].forEach(a=>{const p=a.split(";")[0].split("="),u=p[0],h=p[1];u&&h&&u.length>0&&h.length>0&&(c[u]=h)})}).on("error",o=>{s(o)})})}static async HttpGetJson(e,t="GET",r,s={},i=!0,o=!0){const c=new URL(e),l=e.startsWith("https://")?O:K,a={hostname:c.hostname,port:c.port,path:c.href,method:t,headers:s};return new Promise((p,u)=>{const h=l.request(a,g=>{let C="";g.on("data",d=>{C+=d.toString()}),g.on("end",()=>{try{if(g.statusCode&&g.statusCode>=200&&g.statusCode<300)if(i){const d=JSON.parse(C);p(d)}else p(C);else u(new Error(`Unexpected status code: ${g.statusCode}`))}catch(d){u(d)}})});h.on("error",g=>{u(g)}),(t==="POST"||t==="PUT"||t==="PATCH")&&(o?h.write(JSON.stringify(r)):h.write(r)),h.end()})}static async HttpGetText(e,t="GET",r,s={}){return this.HttpGetJson(e,t,r,s,!1,!1)}static async createFormData(e,t){let r="image/png";t.endsWith(".jpg")&&(r="image/jpeg");const s=[`------${e}\r
`,`Content-Disposition: form-data; name="share_image"; filename="${t}"\r
`,"Content-Type: "+r+`\r
\r
`],i=F.readFileSync(t),o=`\r
------${e}--`;return Buffer.concat([Buffer.from(s.join(""),"utf8"),i,Buffer.from(o,"utf8")])}}class ue{core;constructor(e){this.core=e}async setLongNick(e){return this.core.session.getProfileService().setLongNick(e)}async setSelfOnlineStatus(e,t,r){return this.core.session.getMsgService().setStatus({status:e,extStatus:t,batteryStatus:r})}async getBuddyRecommendContactArkJson(e,t=""){return this.core.session.getBuddyService().getBuddyRecommendContactArkJson(e,t)}async like(e,t=1){return this.core.session.getProfileLikeService().setBuddyProfileLike({friendUid:e,sourceId:71,doLikeCount:t,doLikeTollCount:0})}async setQQAvatar(e){const t=await this.core.session.getProfileService().setHeader(e);return{result:t?.result,errMsg:t?.errMsg}}async getSelfInfo(){}async getUserInfo(e){}async modifySelfProfile(e){return this.core.session.getProfileService().modifyDesktopMiniProfile(e)}async getPSkey(e){return await this.core.session.getTipOffService().getPskey(e,!0)}async getQzoneCookies(e,t){const r="https://ssl.ptlogin2.qq.com/jump?ptlang=1033&clientuin="+e+"&clientkey="+t+"&u1=https%3A%2F%2Fuser.qzone.qq.com%2F"+e+"%2Finfocenter&keyindex=19%27";return await m.HttpsGetCookies(r)}async getSkey(e,t){const r="https://ssl.ptlogin2.qq.com/jump?ptlang=1033&clientuin="+e+"&clientkey="+t+"&u1=https%3A%2F%2Fh5.qzone.qq.com%2Fqqnt%2Fqzoneinpcqq%2Ffriend%3Frefresh%3D0%26clientuin%3D0%26darkMode%3D0&keyindex=19%27",i=(await m.HttpsGetCookies(r)).skey;if(!i)throw new Error("getSkey Skey is Empty");return i}async getRobotUinRange(){return(await this.core.session.getRobotService().getRobotUinRange({justFetchMsgConfig:"1",type:1,version:0,aioKeywordVersion:0}))?.response?.robotUinRanges}async getUidByUin(e){return(await this.core.event.CallNoListenerEvent("NodeIKernelUixConvertService/getUid",5e3,[e])).uidInfo.get(e)}async getUinByUid(e){return e?(await this.core.event.CallNoListenerEvent("NodeIKernelUixConvertService/getUin",5e3,[e])).uinInfo.get(e):""}async getUserDetailInfo(e){let[t,r]=await this.core.event.CallNormalEvent("NodeIKernelProfileService/getUserDetailInfo","NodeIKernelProfileListener/onProfileDetailInfoChanged",2,5e3,s=>s.uid===e,e);return r}static async getCookies(e,t,r){const s="https://ssl.ptlogin2.qq.com/jump?ptlang=1033&clientuin="+e+"&clientkey="+t+"&u1=https%3A%2F%2F"+r+"%2F"+e+"%2Finfocenter&keyindex=19%27";return await m.HttpsGetCookies(s)}async getUserDetailInfoByUin(e){return this.core.event.CallNoListenerEvent("NodeIKernelProfileService/getUserDetailInfoByUin",5e3,e)}async forceFetchClientKey(){return await this.core.session.getTicketService().forceFetchClientKey("")}}class pe{async getGroupEssenceMsg(e,t,r,s){const i="https://qun.qq.com/cgi-bin/group_digest/digest_list?bkn="+s+"&group_code="+e+"&page_start="+t+"&page_limit=20";let o;try{o=await m.HttpGetJson(i,"GET","",{Cookie:r})}catch{return}if(o.retcode===0)return o}async getGroupMembers(e,t,r){let s=new Array;try{const i=[],o=await m.HttpGetJson("https://qun.qq.com/cgi-bin/qun_mgr/search_group_members?st=0&end=40&sort=1&gc="+e+"&bkn="+r,"POST","",{Cookie:t});if(!o?.count||o?.errcode!==0||!o?.mems)return[];for(const l in o.mems)s.push(o.mems[l]);const c=Math.ceil(o.count/40);for(let l=2;l<=c;l++){const a=m.HttpGetJson("https://qun.qq.com/cgi-bin/qun_mgr/search_group_members?st="+(l-1)*40+"&end="+l*40+"&sort=1&gc="+e+"&bkn="+r,"POST","",{Cookie:t});i.push(a)}for(let l=1;l<=c;l++){const a=await i[l];if(!(!a?.count||a?.errcode!==0||!a?.mems))for(const p in a.mems)s.push(a.mems[p])}}catch{return s}return s}async setGroupNotice(e,t="",r,s){let i;const o="https://web.qun.qq.com/cgi-bin/announce/add_qun_notice?bkn="+s;try{return i=await m.HttpGetJson(o,"GET","",{Cookie:r}),i}catch{return}}async getGrouptNotice(e,t,r){let s;const i="https://web.qun.qq.com/cgi-bin/announce/get_t_list?bkn="+r+"&qid="+e+"&ft=23&ni=1&n=1&i=1&log_read=1&platform=1&s=-1&n=20";try{return s=await m.HttpGetJson(i,"GET","",{Cookie:t}),s?.ec!==0?void 0:s}catch{return}}genBkn(e){e=e||"";let t=5381;for(let r=0;r<e.length;r++){const s=e.charCodeAt(r);t=t+(t<<5)+s}return(t&2147483647).toString()}async getGroupHonorInfo(e,t,r){async function s(o,c){let l="https://qun.qq.com/interactive/honorlist?gc="+o+"&type="+c.toString(),a="",p;try{a=await m.HttpGetText(l,"GET","",{Cookie:r});const u=a.match(/window\.__INITIAL_STATE__=(.*?);/);return u&&(p=JSON.parse(u[1].trim())),c===1?p?.talkativeList:p?.actorList}catch{}}let i={group_id:e};if(t==="talkative"||t==="all")try{let o=await s(e,1);if(!o)throw new Error("获取龙王信息失败");i.current_talkative={user_id:o[0]?.uin,avatar:o[0]?.avatar,nickname:o[0]?.name,day_count:0,description:o[0]?.desc},i.talkative_list=[];for(const c of o)i.talkative_list.push({user_id:c?.uin,avatar:c?.avatar,description:c?.desc,day_count:0,nickname:c?.name})}catch{}if(t==="performer"||t==="all")try{let o=await s(e,2);if(!o)throw new Error("获取群聊之火失败");i.performer_list=[];for(const c of o)i.performer_list.push({user_id:c?.uin,nickname:c?.name,avatar:c?.avatar,description:c?.desc})}catch{}if(t==="performer"||t==="all")try{let o=await s(e,3);if(!o)throw new Error("获取群聊炽焰失败");i.legend_list=[];for(const c of o)i.legend_list.push({user_id:c?.uin,nickname:c?.name,avatar:c?.avatar,desc:c?.description})}catch{}if(t==="emotion"||t==="all")try{let o=await s(e,6);if(!o)throw new Error("获取快乐源泉失败");i.emotion_list=[];for(const c of o)i.emotion_list.push({user_id:c?.uin,nickname:c?.name,avatar:c?.avatar,desc:c?.description})}catch{}return(t==="emotion"||t==="all")&&(i.strong_newbie_list=[]),i}}class ge{core;constructor(e){this.core=e}async hasOtherRunningQQProcess(){return this.core.util.hasOtherRunningQQProcess()}async ORCImage(e){return this.core.session.getNodeMiscService().wantWinScreenOCR(e)}async translateEnWordToZn(e){return this.core.session.getRichMediaService().translateEnWordToZn(e)}async getOnlineDev(){return this.core.session.getMsgService().getOnLineDev()}async getArkJsonCollection(e){return await this.core.event.CallNoListenerEvent("NodeIKernelCollectionService/collectionArkShare",5e3,"1717662698058")}async BootMiniApp(e,t){await this.core.session.getNodeMiscService().setMiniAppVersion("2.16.4");let r=await this.core.session.getNodeMiscService().getMiniAppPath();return console.log(r),this.core.session.getNodeMiscService().startNewMiniApp(e,t)}}class he{core;constructor(e){this.core=e}async createCollection(e,t,r,s,i){let o={commInfo:{bid:1,category:2,author:{type:1,numId:e,strId:r,groupId:"0",groupName:"",uid:t},customGroupId:"0",createTime:Date.now().toString(),sequence:Date.now().toString()},richMediaSummary:{originalUri:"",publisher:"",richMediaVersion:0,subTitle:"",title:"",brief:s,picList:[],contentType:1},richMediaContent:{rawData:i,bizDataList:[],picList:[],fileList:[]},need_share_url:!1};return this.core.session.getCollectionService().createNewCollectionItem(o)}async getAllCollection(e=0,t=50){let r={category:e,groupId:-1,forceSync:!0,forceFromDb:!1,timeStamp:"0",count:t,searchDown:!0};return this.core.session.getCollectionService().getCollectionItemList(r)}}class de{session;util;event;ApiCollection;ApiFile;ApiFileCache;ApiFriend;ApiGroup;ApiMsg;ApiSystem;ApiUser;ApiWeb;constructor(e,t){this.session=t,this.util=new e.NodeQQNTWrapperUtil,this.event=new se,this.event.init({ListenerMap:e,WrapperSession:this.session}),this.ApiCollection=new he(this),this.ApiFile=new ie(this),this.ApiFileCache=new oe(this),this.ApiFriend=new ce(this),this.ApiGroup=new ae(this),this.ApiMsg=new le(this),this.ApiSystem=new ge(this),this.ApiUser=new ue(this),this.ApiWeb=new pe}getWrapperSession(){return this.session}getWrapperUtil(){return this.util}getApiCollection(){return this.ApiCollection}getApiFile(){return this.ApiFile}getApiFileCache(){return this.ApiFileCache}getApiFriend(){return this.ApiFriend}getApiGroup(){return this.ApiGroup}getApiMsg(){return this.ApiMsg}getApiSystem(){return this.ApiSystem}getApiUser(){return this.ApiUser}getApiWeb(){return this.ApiWeb}}var f=(n=>(n.sendLog="NodeIQQNTWrapperSession/create/getNodeMiscService/sendLog",n.onQRCodeLoginSucceed="NodeIKernelLoginService/get/addKernelLoginListener/onQRCodeLoginSucceed",n.onRecvMsg="NodeIQQNTWrapperSession/create/getMsgService/addKernelMsgListener/onRecvMsg",n.sendMsg="NodeIQQNTWrapperSession/create/getMsgService/sendMsg",n.requestTianshuAdv="NodeIQQNTWrapperSession/create/getMsgService/requestTianshuAdv",n.onProfileSimpleChanged="NodeIQQNTWrapperSession/create/getProfileService/addKernelProfileListener/onProfileSimpleChanged",n.fetchUserDetailInfo="NodeIQQNTWrapperSession/create/getProfileService/fetchUserDetailInfo",n.onUserDetailInfoChanged="NodeIQQNTWrapperSession/create/getProfileService/addKernelProfileListener/onUserDetailInfoChanged",n.getVasInfo="NodeIQQNTWrapperSession/create/getProfileService/getVasInfo",n.setThemeInfo="NodeIQQNTWrapperSession/create/getSkinService/setThemeInfo",n.onThemeInfoChange="NodeIQQNTWrapperSession/create/getSkinService/addKernelSkinListener/onThemeInfoChange",n.previewTheme="NodeIQQNTWrapperSession/create/getSkinService/previewTheme",n.getSystemThemePackageList="NodeIQQNTWrapperSession/create/getSkinService/getSystemThemePackageList",n.getTemplateThemeList="NodeIQQNTWrapperSession/create/getSkinService/getTemplateThemeList",n.checkMsgWithUrl="NodeIQQNTWrapperSession/create/getMsgService/checkMsgWithUrl",n.onRecvActiveMsg="nodeIKernelMsgListener/onRecvActiveMsg",n))(f||{});let H,j,G;const z=new te.EventEmitter,Y=new Map,$=new Map;let T;const D=({argArray:n,ret:e,key:t})=>{if(t.endsWith("Service")&&$.has(t)||!T?.log)return;t.endsWith("Service")&&$.set(t,!0);const r=null;if(console.log("-----------------------------------------------"),console.log(`${t} 被调用`),n.length&&console.log("参数: ",I.inspect(n,{depth:r,colors:!0})),e instanceof Promise)console.log("返回值为 Promise，请观察后续打印内容"),e.then(s=>{console.log(`${t} 返回值: `),console.log(I.inspect(s,{depth:r,colors:!0}))},s=>{console.log(`${t} 返回值: `),console.log(I.inspect(s,{depth:r,colors:!0}))});else if(console.log("返回值: ",I.inspect(e,{depth:r,colors:!0})),typeof e=="object"&&e){const s=Object.getOwnPropertyNames(e);s.length&&console.log("返回值 keys: ",I.inspect(s,{depth:r,colors:!0})),console.log("原型 keys: ",I.inspect(Object.getOwnPropertyNames(Object.getPrototypeOf(e)),{depth:r,colors:!0}))}},A=({instance:n,rootKey:e})=>new Proxy(n,{get(t,r,s){const i=Reflect.get(n,r,s);if(typeof i!="function")return i;const o=`${e}/${r}`;return(...c)=>{if(T?.eventBlacklist?.some(p=>typeof p=="string"?o===p:p.test(o)))return;o.endsWith("Listener")&&(c[0]=A({instance:c[0],rootKey:o}),Y.set(o,c[0])),c=T?.eventInterceptors?.[o]?.(c)??c;let a=n[r](...c);return a=T?.eventInterceptors?.[`${o}:response`]?.(a)??a,o.endsWith("Service")&&(a=A({instance:a,rootKey:o})),z.emit(o,{applyRet:a,args:c}),D({argArray:c,ret:a,key:o}),a}}}),fe=n=>{T=n;const{promise:e,resolve:t}=Promise.withResolvers();return B.dlopen=new Proxy(B.dlopen,{apply(r,s,i){const[,o]=i,c=Reflect.apply(r,s,i);if(o.includes("wrapper.node")){const l=i[0].exports,a=new Proxy(l,{get(p,u,h){const g=Reflect.get(l,u,h);return typeof g!="function"?g:new Proxy(function(){},{get(C,d,y){const v=Reflect.get(g,d,y);return typeof v!="function"?v:new Proxy(v,{apply(R,E,M){const L=Reflect.apply(R,E,M),U=`${u}/${d}`;if(D({argArray:M,ret:L,key:U}),typeof L!="object")return L;const x=A({instance:L,rootKey:U});return U==="NodeIQQNTWrapperSession/create"&&(H=x),x}})},construct(C,d,y){const v=Reflect.construct(g,d,y);return D({key:u,ret:v,argArray:d}),A({instance:v,rootKey:u})}})}});j=i[0].exports=a}return c}}),z.once(f.onQRCodeLoginSucceed,()=>{t(G=new de(j,H))}),e},P=n=>(n.vipStartFlag=0,n.vipDataFlag=0,n.vipFlag=!0,n.svipFlag=!0,n.yearVipFlag=!0,n.vipLevel=10,n.nameplateVipType=258,n.superVipTemplateId=20471,n.pendantId=104493,n.vipDataFlag=107,n.vipNameColorId="6",n.privilegeIcon.openIconList=[],n.privilegeIcon.closeIconList=[],n),b=()=>globalThis?.authData?.uid??"",me={async[f.fetchUserDetailInfo+":response"](n){const e=b(),t=await n,r=t.detail.get(e);if(r)return r.simpleInfo.vasInfo=P(r.simpleInfo.vasInfo),t},[f.onUserDetailInfoChanged]([n]){const e=b();n.uid===e&&(n.simpleInfo.vasInfo=P(n.simpleInfo.vasInfo))},[f.onProfileSimpleChanged]([n]){const e=b(),t=n.get(e);!t||!t.vasInfo||(t.vasInfo=P(t.vasInfo))},[f.getVasInfo+":response"](n){const e=b(),t=n.get(e);t&&P(t)}},J={theme:null},ye=4,ve="extension",Se="星之杖",_="liteloader-star-wand",we="你相信魔法吗",Ce="0.0.8",Ie=[{name:"Nyaruhodo",link:"https://github.com/nyaruhodoo"}],ke={repo:"nyaruhodoo/LiteLoader-StarWand",branch:"master"},Ne=[],Te=["win32","linux","darwin"],Me={renderer:"./out/renderer/index.js",main:"./out/main/index.js",preload:"./out/preload/index.js"},Le="./icon.gif",Pe="./thumb.svg",q={manifest_version:ye,type:ve,name:Se,slug:_,description:we,version:Ce,authors:Ie,repository:ke,dependencies:Ne,platform:Te,injects:Me,icon:Le,thumb:Pe};let be=class X{static async getConfig(){const e=await LiteLoader.api.config.get(q.slug,J);return this.mergeConfig(e,J)}static async updateConfig(e){await LiteLoader.api.config.set(q.slug,e),this.log("Config已更新",JSON.stringify(e))}static mergeConfig(e,t){const r=structuredClone(t);for(const[s,i]of Object.entries(e))if(Object.hasOwn(r,s)&&Object.prototype.toString.call(i)===Object.prototype.toString.call(r[s])){if(Array.isArray(i)){r[s]=[...new Set([...i,...r[s]])];continue}if(typeof i=="object"&&i){r[s]=this.mergeConfig(i,r[s]);continue}r[s]=i}return r}static log(...e){console.log(`${q.slug}:`,...e)}static randomInteger(e,t){const r=e+Math.random()*(t+1-e);return Math.floor(r)}static wait(e){if(!(e<=0))return new Promise(t=>setTimeout(t,e))}static createDeepProxy(e,t){for(const r in e)typeof e[r]=="object"&&e[r]&&(e[r]=X.createDeepProxy(e[r],t));return new Proxy(e,t)}static getProperty(e,t){let r=e;const s=t.split(".");for(;s.length;){const i=s.shift();if(!i)return;r=r[i]}return r}static setProperty(e,t,r){let s=e;const i=t.split("."),o=i.pop();if(o){for(;i.length;){const c=i.shift();if(!c)return;s=s[c]}return s[o]=r}}},Q,W;const Z=n=>{if(n instanceof Map){const e={};for(const[t,r]of n)e[t]=r;return e}else if(typeof n=="object"&&n!==null){const e=new Map;for(const t in n)Object.prototype.hasOwnProperty.call(n,t)&&e.set(t,n[t]);return e}else throw new Error("输入必须是 Map 或 Object")},Fe=(n,e)=>{for(const t of e){const r=t.themeList.find(s=>s.themeId===n);if(r)return r}},Ae=async n=>{const e=Y.get("NodeIQQNTWrapperSession/create/getSkinService/addKernelSkinListener");if(!e||!W)return;const t=n[0];let r=Fe(n[0],W);r||(r={themeId:t,themeName:n[2].themeName,themeDesc:"",requirement:0,themeMediaPreview:"",themeVideo:"",themePalette:"",themePreviewLight:"",themePreviewDark:"",light:{primaryColor:n[2].primaryColor,aioInfo:n[2].aioInfo,bubbleInfo:n[2].bubbleInfo},dark:{primaryColor:n[2].primaryColor,aioInfo:n[2].aioInfo,bubbleInfo:n[2].bubbleInfo}});const s=[t,r,null,null,Q];await be.updateConfig({theme:[t,r,null,null,Z(Q)]}),e.onThemeInfoChange(...s)},Ge={async[`${f.getSystemThemePackageList}:response`](n){return W=(await n).systemThemePackageList,n},async[`${f.previewTheme}:response`](n){return Q=(await n).tokenMap,n},[f.setThemeInfo](n){Ae(n)},async[`${f.setThemeInfo}:response`](){return{result:0,errMsg:""}},[f.onThemeInfoChange](n){const e=`${LiteLoader.plugins[_].path.data}/config.json`;if(!F.existsSync(e))return n;try{const t=JSON.parse(F.readFileSync(`${LiteLoader.plugins[_].path.data}/config.json`,"utf8"));if(!t.theme)return;const r=t.theme[0];return n[0]!==r?(t.theme[4]=Z(t.theme[4]),t.theme):n}catch(t){console.log(t)}return n}};class w{static isVideoFile(e){const t=[".mp4",".avi",".mkv",".mov",".wmv",".flv",".webm",".m4v",".mpeg",".mpg",".3gp"],r=S.extname(e).toLowerCase();return t.includes(r)}static isImgFile(e){const t=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".avif",".svg"],r=S.extname(e).toLowerCase();return t.includes(r)}static getFileMD5(e){const t=ne.createHash("md5"),r=F.readFileSync(e);return t.update(r),t.digest("hex")}static checkFileExists(e,t=200,r=10){const{promise:s,resolve:i,reject:o}=Promise.withResolvers();let c=0;const l=async()=>{c++;try{await N.access(e),i(e)}catch{c>r&&o(new Error("找不到视频封面")),setTimeout(l,t)}};return l(),s}static async copyFileWithDirCheck(e,t){const r=S.dirname(t);try{await N.access(r,N.constants.F_OK)}catch{await N.mkdir(r,{recursive:!0})}await N.copyFile(e,t)}}const ee=(n,e,t)=>{const r=w.getFileMD5(n),s=G?.session.getMsgService().getRichMediaFilePathForGuild({md5HexStr:r,fileName:e,elementType:t,elementSubType:0,thumbSize:0,needCreate:!0,downloadType:1,file_uuid:""});if(!s)throw new Error("无法获取视频上传路径");return{uploadPath:s,md5HexStr:r}},Re=n=>{const e=n.replace("Ori","Thumb"),t=S.dirname(e),r=S.extname(e),i=`${S.basename(e,r)}_0.png`;return S.join(t,i)},Ue=async n=>{const{fileName:e,filePath:t,picHeight:r,picWidth:s,picThumbPath:i,fileSize:o}=n[2][0].fileElement,{md5HexStr:c,uploadPath:l}=ee(t,e,k.VIDEO),a=i?.get(750);if(!a)throw new Error("视频封面丢失");await Promise.all([w.copyFileWithDirCheck(t,l),w.checkFileExists(a)]);const p=Re(l);await w.copyFileWithDirCheck(a,p);const u=new Map;u.set(0,p);const h={elementType:k.VIDEO,elementId:"",videoElement:{filePath:l,fileName:e,videoMd5:c,thumbMd5:w.getFileMD5(a),fileSize:o,thumbWidth:s,thumbHeight:r,thumbPath:u}};return n[2][0]=h,G?.session.getMsgService().sendMsg(...n)},qe=async n=>{const{fileName:e,filePath:t,picHeight:r,picWidth:s,fileSize:i}=n[2][0].fileElement,{md5HexStr:o,uploadPath:c}=ee(t,e,k.PIC);await w.copyFileWithDirCheck(t,c);const l={elementType:k.PIC,elementId:"",picElement:{md5HexStr:o,fileSize:i,picWidth:s??0,picHeight:r??0,fileName:`${o}.${S.extname(t).toLowerCase()}`,sourcePath:"",original:!0,picType:1e3,picSubType:0,fileUuid:"",fileSubId:"",thumbFileSize:0,summary:""}};return n[2][0]=l,G?.session.getMsgService().sendMsg(...n)},De={[f.sendMsg](n){if(n[1].chatType===8||n[2][0].elementType!==k.FILE)return n;const{filePath:e,fileSize:t}=n[2][0].fileElement;if(+t/1024/1024>=99)return n;if(w.isVideoFile(e))throw Ue(n),new Error("喵喵喵");if(w.isImgFile(e))throw qe(n),new Error("喵喵喵");return n}},_e={async[`${f.checkMsgWithUrl}:response`](n){const e=await n;for(const t of e.checkUrlsResult)t.jumpUrl=t.url,t.jumpResult=11;return n}};(async()=>await fe({log:!1,eventBlacklist:[f.sendLog,/tianshu/i],eventInterceptors:{...me,...Ge,...De,..._e}}))();
